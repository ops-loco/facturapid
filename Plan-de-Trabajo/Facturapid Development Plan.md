# Facturapid Development Plan

This document outlines the development plan for the Facturapid project, detailing the phases, tasks, and technical considerations for each component.

## Phase 1: Go Synchronizer Development (Priority: High)

**Objective:** Develop the critical component that integrates with the existing TPV system on Windows 7, monitors invoices, communicates with the API, and prints QR codes.

**Tasks:**

1.  **Environment Setup:**
    *   Configure Go development environment.
    *   Prepare a Windows 7 testing environment (VM or physical machine) for accurate testing and deployment validation.
    *   Consider cross-compilation strategies if developing on a different OS.
2.  **MS Access Database Connectivity:**
    *   Research and select a reliable Go library for `.mdb` access on Windows 7 (e.g., `alexbrainman/odbc`). Define fallback strategies (e.g., Java bridge via UCanAccess) if native Go proves unstable.
    *   Implement connection logic using the provided path (`c:\tpv\tpv.mdb`) and password (`mcdqn`).
    *   Implement robust error handling and reconnection logic for database interactions.
3.  **Invoice Monitoring Logic:**
    *   Develop a polling mechanism to query the `Factura` table at regular intervals (e.g., every 5-10 seconds).
    *   Query criteria: `Cliente1 = 'QR'` AND `Impresa = 'S'`.
    *   Implement a mechanism to track already processed invoices (e.g., storing the last processed `Codigo` or timestamp in a local file or state) to prevent redundant processing.
4.  **Data Extraction:**
    *   Write SQL queries to fetch all required fields from the `Factura` table for qualifying records.
    *   Write SQL queries to fetch corresponding line items from `FacturasLin` using the `CodigoFactura`.
5.  **API Client Implementation:**
    *   Define Go structs representing the invoice header and line data structure expected by the REST API.
    *   Implement an HTTP client to send POST requests containing the invoice data to the `/invoices` endpoint of the REST API.
    *   Implement the agreed-upon authentication mechanism (e.g., API Key in header) for secure communication with the API.
    *   Handle API responses, including retrieving the unique invoice ID generated by the API.
6.  **QR Code Generation:**
    *   Integrate a Go QR code generation library (e.g., `skip2/go-qrcode`).
    *   Construct the unique frontend URL using the base frontend domain and the unique invoice ID received from the API (e.g., `https://your-frontend-domain.com/invoice/{api_invoice_id}`).
    *   Generate the QR code image representing this URL.
7.  **Ticket Printing (LPT1/ESC/POS):**
    *   Research methods for sending data/commands to the LPT1 port on Windows 7 from Go. This might involve platform-specific APIs (`syscall`) or potentially wrapping existing command-line tools or libraries if direct Go options are limited.
    *   Implement logic to send appropriate ESC/POS commands to the Epson TM-T88 printer to print the generated QR code.
    *   Handle potential printing errors.
8.  **Windows Service Implementation:**
    *   Utilize a library like `kardianos/service` to enable the Go application to run as a background Windows service.
    *   Develop simple installation (`install.bat`) and uninstallation (`uninstall.bat`) scripts for easy deployment.
9.  **Testing:**
    *   Unit tests for individual functions (data extraction, QR generation).
    *   Integration tests within the Windows 7 environment simulating the TPV database, API interaction (mock or real), and printing.

## Phase 2: REST API Development (Backend)

**Objective:** Create the central API to manage invoice data, handle updates, and generate PDF invoices.

**Tasks:**

1.  **Technology Selection & Setup:**
    *   Choose and set up a Go web framework (e.g., Gin, Echo).
    *   Set up the chosen database (PostgreSQL recommended) and configure connection details.
    *   Establish project structure.
2.  **Database Schema Design:**
    *   Design and create database tables (`invoices`, `invoice_lines`) with appropriate columns, data types, and relationships to store invoice header, lines, and customer fiscal data.
3.  **API Endpoint Implementation:**
    *   `/invoices` (POST): Implement logic to receive invoice data, validate inputs, perform authentication check (API key), store data in the database, generate a unique internal ID, and return this ID.
    *   `/invoices/{id}` (GET): Implement logic to retrieve invoice details (header and lines) based on the unique ID.
    *   `/invoices/{id}` (PUT): Implement logic to receive customer fiscal data, validate inputs, and update the corresponding invoice record in the database.
    *   `/invoices/{id}/pdf` (GET): Implement logic to retrieve the full invoice data (including fiscal details), generate a PDF document using a Go PDF library (e.g., `jung-kurt/gofpdf`), and return the PDF file.
4.  **Security Implementation:**
    *   Configure HTTPS for the API server.
    *   Implement robust input validation and sanitization for all incoming data.
    *   Implement the chosen authentication mechanism for the synchronizer.
5.  **Testing:**
    *   Unit tests for business logic (data validation, PDF generation).
    *   API endpoint testing using tools like Postman or `curl` to verify request/response behavior and data persistence.

## Phase 3: React Frontend Development

**Objective:** Build the user-facing web application for customers to provide fiscal data and download their invoices.

**Tasks:**

1.  **Environment Setup:**
    *   Set up Node.js, npm/yarn, and initialize a React project (Create React App or Vite).
    *   Choose a state management library (Context API, Zustand, Redux) and UI library/styling approach (CSS Modules, Tailwind CSS, Material UI).
2.  **Project Structure & Routing:**
    *   Organize components logically (e.g., views, forms, display elements).
    *   Configure React Router to handle the `/invoice/:id` route, extracting the invoice ID from the URL.
3.  **API Integration:**
    *   Implement functions using `fetch` or `axios` to interact with the REST API:
        *   Fetch initial invoice data (`GET /invoices/{id}`).
        *   Submit fiscal data (`PUT /invoices/{id}`).
        *   Trigger PDF download (`GET /invoices/{id}/pdf`).
4.  **UI Development:**
    *   Create the main invoice view page.
    *   Display the initial invoice details fetched from the API.
    *   Build the fiscal data input form with fields for Name, Address, NIF/CIF, etc.
    *   Implement client-side validation for the form fields.
    *   Develop the user flow: view details -> fill form -> submit -> download PDF link/button appears.
    *   Ensure responsive design for mobile and desktop use.
5.  **State Management:**
    *   Manage application state, including fetched invoice data, form inputs, loading states, and error messages.
6.  **Testing:**
    *   Component tests for individual UI elements and forms.
    *   End-to-end tests (e.g., using Cypress) simulating user interaction from landing on the page to downloading the PDF.
7.  **Build Configuration:**
    *   Configure the build process to generate optimized static assets for deployment.

## Phase 4: Integration, Testing, Deployment & Documentation

**Objective:** Integrate all components, perform comprehensive testing, deploy the system, and finalize documentation.

**Tasks:**

1.  **End-to-End Integration Testing:**
    *   Set up a complete test environment mimicking production (Windows 7 machine with synchronizer, API server, database, web server for frontend).
    *   Test the entire workflow: Simulate TPV entry -> Verify synchronizer picks up data -> Verify API receives data -> Access frontend via generated URL -> Submit fiscal data -> Verify API updates data -> Download and verify PDF.
2.  **Security Review:**
    *   Conduct a final review of security measures across all components (HTTPS, authentication, input validation, vulnerability checks).
3.  **Deployment:**
    *   Deploy the REST API and database to the target server environment.
    *   Deploy the built React frontend assets to the Plesk server, configuring the web server as needed.
    *   Install and configure the Go synchronizer service on the designated Windows 7 machine(s) at the restaurant.
4.  **Documentation Finalization:**
    *   Complete technical documentation for each component.
    *   Finalize the installation and configuration manual for the synchronizer.
    *   Finalize the deployment instructions for the API and frontend (including Plesk specifics).
5.  **User Acceptance Testing (UAT):**
    *   Coordinate with stakeholders for final testing and approval.
6.  **Handover:**
    *   Package and deliver all source code, documentation, manuals, and deployment artifacts.

This plan provides a structured approach to developing the Facturapid system, prioritizing the critical Windows 7 integration component first.
